<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YVR Water Fountains - Admin Review Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .container {
            max-width: 1200px;
        }
        
        .main-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }
        
        .map-section {
            background: #f8f9fa;
            padding: 0;
            position: relative;
        }
        
        .form-section {
            padding: 30px;
            overflow-y: auto;
            max-height: 80vh;
        }
        
        #map {
            height: 100%;
            min-height: 500px;
            width: 100%;
        }
        
        .search-container {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .search-container input {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .search-container input:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }
        
        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .rating-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .rating-item {
            text-align: center;
        }
        
        .rating-item label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .rating-input {
            width: 80px;
            height: 80px;
            border: 3px solid #e0e0e0;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 0 auto;
            display: block;
            transition: all 0.3s;
        }
        
        .rating-input:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            transition: transform 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .fountain-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .fountain-info h5 {
            color: #2196F3;
            margin-bottom: 15px;
        }
        
        .alert {
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }
            
            .map-section {
                height: 300px;
            }
            
            .rating-group {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .rating-input {
                width: 60px;
                height: 60px;
                font-size: 18px;
            }
        }
        
        /* Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .leaflet-popup-content {
            margin: 15px;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <div class="header">
                <h1><i class="fas fa-tint"></i> YVR Water Fountains</h1>
                <p>Admin Instagram Review Form</p>
            </div>
            
            <div class="content-wrapper">
                <div class="map-section">
                    <div class="search-container">
                        <div class="row g-2">
                            <div class="col">
                                <input type="text" id="fountainIdInput" class="form-control" placeholder="Search fountain by ID or name...">
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-outline-primary" onclick="searchFountain()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="map"></div>
                </div>
                
                <div class="form-section">
                    <div id="loadingMessage" class="loading">
                        <div class="spinner"></div>
                        <p>Loading fountain data...</p>
                    </div>
                    
                    <div id="reviewForm" style="display: none;">
                        <div id="alertContainer"></div>
                        
                        <div id="fountainInfo" class="fountain-info" style="display: none;">
                            <h5><i class="fas fa-map-marker-alt"></i> Selected Fountain</h5>
                            <div id="fountainDetails"></div>
                        </div>
                        
                        <form id="adminReviewForm">
                            <div class="form-group">
                                <label for="instagramUrl" class="form-label">
                                    <i class="fab fa-instagram"></i> Instagram Post URL *
                                </label>
                                <input type="url" class="form-control" id="instagramUrl" required 
                                       placeholder="https://www.instagram.com/p/ABC123/">
                                <small class="form-text text-muted">Paste the full Instagram post URL</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="instagramCaption" class="form-label">Instagram Caption</label>
                                <textarea class="form-control" id="instagramCaption" rows="3" 
                                         placeholder="Optional caption from the Instagram post..."></textarea>
                            </div>
                            
                            <div class="rating-group">
                                <div class="rating-item">
                                    <label for="overallRating">Overall Rating</label>
                                    <input type="number" class="form-control rating-input" id="overallRating" 
                                           min="1" max="10" required>
                                </div>
                                <div class="rating-item">
                                    <label for="waterQuality">Water Quality</label>
                                    <input type="number" class="form-control rating-input" id="waterQuality" 
                                           min="1" max="10" required>
                                </div>
                                <div class="rating-item">
                                    <label for="flowPressure">Flow Pressure</label>
                                    <input type="number" class="form-control rating-input" id="flowPressure" 
                                           min="1" max="10" required>
                                </div>
                                <div class="rating-item">
                                    <label for="temperature">Temperature</label>
                                    <input type="number" class="form-control rating-input" id="temperature" 
                                           min="1" max="10" required>
                                </div>
                                <div class="rating-item">
                                    <label for="drainage">Drainage</label>
                                    <input type="number" class="form-control rating-input" id="drainage" 
                                           min="1" max="10" required>
                                </div>
                                <div class="rating-item">
                                    <label for="accessibility">Accessibility</label>
                                    <input type="number" class="form-control rating-input" id="accessibility" 
                                           min="1" max="10" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="reviewNotes" class="form-label">Additional Notes</label>
                                <textarea class="form-control" id="reviewNotes" rows="4" 
                                         placeholder="Any additional observations or details..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="visitDate" class="form-label">Visit Date</label>
                                <input type="date" class="form-control" id="visitDate" required>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paper-plane"></i> Submit Admin Review
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load configuration -->
    <script src="config.js"></script>
    
    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Configuration - using secure API endpoints only
        console.log('🔐 Admin form configured for secure API submission');
        
        // Global variables
        let map;
        let fountainsData = [];
        let markers = [];
        let selectedFountain = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize admin form (password check happens during submission for security)
            initializeMap();
            loadFountainData();
            setupEventListeners();
            setDefaultDate();
        });
        
        function initializeMap() {
            // Initialize map centered on Vancouver
            map = L.map('map').setView([49.251, -123.060], 11);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }
        
        function loadFountainData() {
            // Load fountain data from GeoJSON
            fetch(window.APP_CONFIG.GEOJSON_PATH)
                .then(response => response.json())
                .then(data => {
                    fountainsData = data.features;
                    addFountainsToMap();
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('reviewForm').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading fountain data:', error);
                    showAlert('Failed to load fountain data. Please refresh the page and try again.', 'danger');
                    document.getElementById('loadingMessage').innerHTML = 
                        '<p class="text-danger">Failed to load fountain data</p>';
                });
        }
        
        function addFountainsToMap() {
            fountainsData.forEach(fountain => {
                const coords = fountain.geometry.coordinates;
                const props = fountain.properties;
                
                const marker = L.marker([coords[1], coords[0]])
                    .addTo(map)
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <h6><strong>${props.name}</strong></h6>
                            <p><strong>ID:</strong> ${props.id}</p>
                            <p><strong>Location:</strong> ${props.city}, ${props.neighborhood}</p>
                            <button class="btn btn-primary btn-sm" onclick="selectFountain('${props.id}')">
                                Select This Fountain
                            </button>
                        </div>
                    `);
                
                marker.fountainId = props.id;
                markers.push(marker);
            });
        }
        
        function searchFountain() {
            const searchTerm = document.getElementById('fountainIdInput').value.toLowerCase();
            if (!searchTerm) return;
            
            const fountain = fountainsData.find(f => 
                f.properties.id.toLowerCase().includes(searchTerm) ||
                f.properties.name.toLowerCase().includes(searchTerm)
            );
            
            if (fountain) {
                const coords = fountain.geometry.coordinates;
                map.setView([coords[1], coords[0]], 16);
                
                const marker = markers.find(m => m.fountainId === fountain.properties.id);
                if (marker) {
                    marker.openPopup();
                }
            } else {
                showAlert('Fountain not found. Try searching by ID or name.', 'warning');
            }
        }
        
        function selectFountain(fountainId) {
            const fountain = fountainsData.find(f => f.properties.id === fountainId);
            if (!fountain) return;
            
            selectedFountain = fountain;
            
            // Update fountain info display
            const fountainInfo = document.getElementById('fountainInfo');
            const fountainDetails = document.getElementById('fountainDetails');
            
            fountainDetails.innerHTML = `
                <p><strong>ID:</strong> ${fountain.properties.id}</p>
                <p><strong>Name:</strong> ${fountain.properties.name}</p>
                <p><strong>Location:</strong> ${fountain.properties.city}, ${fountain.properties.neighborhood}</p>
                <p><strong>Type:</strong> ${fountain.properties.type}</p>
                <p><strong>Maintainer:</strong> ${fountain.properties.maintainer}</p>
            `;
            
            fountainInfo.style.display = 'block';
            
            // Close popup
            map.closePopup();
            
            showAlert('Fountain selected! Fill out the review form below.', 'success');
        }
        
        function setupEventListeners() {
            // Form submission
            document.getElementById('adminReviewForm').addEventListener('submit', handleFormSubmit);
            
            // Search input
            document.getElementById('fountainIdInput').addEventListener('keydown', handleSearchKeydown);
        }
        
        // Handle search keydown (Enter key)
        function handleSearchKeydown(e) {
            if (e.key === 'Enter') {
                searchFountain();
            }
        }
        
        function setDefaultDate() {
            // Set default visit date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('visitDate').value = today;
        }
        
        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!selectedFountain) {
                showAlert('Please select a fountain from the map first.', 'warning');
                return;
            }
            
            // Submit via secure API endpoint
            if (window.APP_CONFIG.ENABLE_API_SUBMISSION) {
                submitToAPI();
            } else {
                generatePythonCommand();
            }
        }
        
        function generatePythonCommand() {
            const formData = getFormData();
            
            const command = `python scripts/rating_helper.py add_full_rating "${selectedFountain.properties.id}" ${formData.overallRating} ${formData.waterQuality} ${formData.flowPressure} ${formData.temperature} ${formData.drainage} ${formData.accessibility} "${formData.notes}" False "${formData.visitDate}" "${formData.instagramUrl}" "YVR Water Fountains"`;
            
            showAlert(`
                <strong>Static Mode:</strong> Copy and run this command in your local environment:<br><br>
                <code style="background: #f8f9fa; padding: 10px; border-radius: 5px; display: block; margin: 10px 0; word-break: break-all;">
                    ${command}
                </code>
                <br>Then regenerate the data with: <code>python scripts/generate_geojson_api.py</code>
            `, 'info');
        }
        
        // Submit admin review via secure API
        async function submitToAPI() {
            const formData = getFormData();
            const adminPassword = prompt('Enter admin password:');
            
            if (!adminPassword) {
                showAlert('Admin password required', 'warning');
                return;
            }
            
            try {
                const apiEndpoint = window.APP_CONFIG.API_ENDPOINT || '/.netlify/functions/submit-review';
                console.log('Using API endpoint:', apiEndpoint);
                
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reviewType: 'admin',
                        reviewData: {
                            fountainId: selectedFountain.properties.id,
                            adminPassword: adminPassword,
                            overallRating: formData.overallRating,
                            waterQuality: formData.waterQuality,
                            flowPressure: formData.flowPressure,
                            temperature: formData.temperature,
                            drainage: formData.drainage,
                            accessibility: formData.accessibility,
                            notes: formData.notes,
                            visitDate: formData.visitDate,
                            instagramUrl: formData.instagramUrl,
                            instagramCaption: formData.instagramCaption
                        }
                    })
                });

                let result;
                let responseText;
                try {
                    // Try to get the response text first for debugging
                    responseText = await response.clone().text();
                    console.log('Raw response:', responseText);
                    console.log('Response status:', response.status);
                    console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                    
                    result = await response.json();
                } catch (jsonError) {
                    console.error('Failed to parse response as JSON:', jsonError);
                    console.error('Response text was:', responseText);
                    throw new Error(`Server returned invalid response format. Response was: ${responseText?.substring(0, 200)}...`);
                }

                if (!response.ok) {
                    throw new Error(result.error || result.message || 'Failed to submit admin review');
                }

                showAlert(`🎉 ${result.message}`, 'success');
                resetForm();
                
            } catch (error) {
                console.error('API submission error:', error);
                showAlert(`Failed to submit admin review: ${error.message}`, 'danger');
            }
        }
        
        function getFormData() {
            return {
                overallRating: parseInt(document.getElementById('overallRating').value),
                waterQuality: parseInt(document.getElementById('waterQuality').value),
                flowPressure: parseInt(document.getElementById('flowPressure').value),
                temperature: parseInt(document.getElementById('temperature').value),
                drainage: parseInt(document.getElementById('drainage').value),
                accessibility: parseInt(document.getElementById('accessibility').value),
                notes: document.getElementById('reviewNotes').value,
                visitDate: document.getElementById('visitDate').value,
                instagramUrl: document.getElementById('instagramUrl').value,
                instagramCaption: document.getElementById('instagramCaption').value
            };
        }
        
        function extractInstagramPostId(url) {
            const match = url.match(/\/p\/([A-Za-z0-9_-]+)/);
            return match ? match[1] : null;
        }
        
        function resetForm() {
            document.getElementById('adminReviewForm').reset();
            document.getElementById('fountainInfo').style.display = 'none';
            selectedFountain = null;
            setDefaultDate();
        }
        
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // Auto-dismiss success alerts after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }
        
        // Make selectFountain globally available
        window.selectFountain = selectFountain;
    </script>
</body>
</html>
